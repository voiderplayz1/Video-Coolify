<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VFXAI â€” Make My Video Cool</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

:root {
  --bg: #080c10;
  --surface: #0d1117;
  --surface2: #111823;
  --border: #1c2a3a;
  --border2: #243040;
  --cyan: #4fc3f7;
  --green: #69f0ae;
  --text: #c8d8e8;
  --muted: #4a6070;
  --accent: #e8f4ff;
  --r: 8px;
  --mono: 'Share Tech Mono', monospace;
  --sans: 'Rajdhani', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
  background: var(--bg); color: var(--text);
  font-family: var(--sans); min-height: 100%;
  line-height: 1.5; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    repeating-linear-gradient(0deg, transparent 0px, transparent 3px, rgba(0,0,0,0.07) 3px, rgba(0,0,0,0.07) 4px),
    radial-gradient(ellipse at 50% 0%, rgba(30,60,100,0.2) 0%, transparent 65%);
}

/* DEVICE POPUP */
#deviceOverlay {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(4,8,14,0.97);
  display: flex; align-items: center; justify-content: center; padding: 20px;
}
#deviceOverlay.hidden { display: none; }
.device-popup {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 16px; padding: 48px 40px 40px;
  max-width: 440px; width: 100%; text-align: center; position: relative;
  box-shadow: 0 0 60px rgba(79,195,247,0.06), 0 24px 48px rgba(0,0,0,0.6);
  animation: popIn 0.45s cubic-bezier(0.22,1,0.36,1) forwards;
}
@keyframes popIn {
  from { opacity: 0; transform: scale(0.88) translateY(24px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}
.corner { position: absolute; width: 14px; height: 14px; border-color: var(--cyan); border-style: solid; opacity: 0.5; }
.corner.tl { top:12px; left:12px;   border-width: 2px 0 0 2px; }
.corner.tr { top:12px; right:12px;  border-width: 2px 2px 0 0; }
.corner.bl { bottom:12px; left:12px;  border-width: 0 0 2px 2px; }
.corner.br { bottom:12px; right:12px; border-width: 0 2px 2px 0; }
.popup-eyebrow { font-family: var(--mono); font-size: 10px; color: var(--cyan); letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 18px; opacity: 0.7; }
.device-popup h2 { font-size: 15px; font-weight: 600; color: var(--accent); line-height: 1.6; margin-bottom: 6px; }
.device-popup .dsub { font-family: var(--mono); font-size: 11px; color: var(--muted); margin-bottom: 34px; }
.device-btn {
  display: flex; align-items: center; gap: 18px;
  width: 100%; padding: 18px 22px;
  background: var(--bg); border: 1px solid var(--border2);
  border-radius: var(--r); cursor: pointer; margin-bottom: 12px;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  text-align: left; color: var(--text); font-family: var(--sans);
}
.device-btn:hover { border-color: var(--cyan); background: rgba(79,195,247,0.04); box-shadow: 0 0 20px rgba(79,195,247,0.1); }
.device-btn .icon { font-size: 28px; flex-shrink: 0; }
.device-btn .dlbl  { font-size: 17px; font-weight: 700; color: var(--accent); }
.device-btn .ddesc { font-size: 11px; color: var(--muted); font-family: var(--mono); margin-top: 3px; }

/* DOWNLOAD POPUP */
#dlOverlay {
  position: fixed; inset: 0; z-index: 8888;
  background: rgba(4,8,14,0.85); backdrop-filter: blur(10px);
  display: none; align-items: center; justify-content: center; padding: 20px;
}
#dlOverlay.open { display: flex; }
.dl-popup {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 16px; padding: 36px 32px 28px;
  max-width: 360px; width: 100%;
  animation: popIn 0.3s cubic-bezier(0.22,1,0.36,1);
}
.dl-popup h3 { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
.dl-popup .dlsub { font-family: var(--mono); font-size: 11px; color: var(--muted); margin-bottom: 26px; }
.dl-opt {
  display: flex; align-items: center; gap: 16px;
  width: 100%; padding: 16px 18px;
  background: var(--bg); border: 1px solid var(--border2);
  border-radius: var(--r); cursor: pointer; margin-bottom: 10px;
  transition: border-color 0.2s, background 0.2s;
  font-family: var(--sans); color: var(--text);
}
.dl-opt:hover { border-color: var(--cyan); background: rgba(79,195,247,0.04); }
.dl-opt .fmt { font-family: var(--mono); font-size: 16px; font-weight: 700; color: var(--cyan); width: 56px; flex-shrink: 0; }
.dl-opt .fo-lbl  { font-size: 14px; font-weight: 700; color: var(--accent); }
.dl-opt .fo-desc { font-size: 11px; color: var(--muted); font-family: var(--mono); margin-top: 3px; }
.dl-cancel {
  width: 100%; padding: 11px; background: transparent;
  border: 1px solid var(--border); border-radius: var(--r);
  color: var(--muted); font-family: var(--sans); font-size: 13px;
  cursor: pointer; margin-top: 4px; transition: border-color 0.2s;
}
.dl-cancel:hover { border-color: var(--muted); }

/* HEADER */
header {
  position: relative; z-index: 10;
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 40px; border-bottom: 1px solid var(--border);
}
.logo { display: flex; align-items: center; gap: 12px; font-family: var(--mono); font-size: 15px; color: var(--accent); letter-spacing: 0.08em; }
.logo-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--cyan); box-shadow: 0 0 8px var(--cyan); animation: blink 1.8s ease-in-out infinite; }
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
.header-tag { font-family: var(--mono); font-size: 10px; color: var(--muted); letter-spacing: 0.15em; }

/* MAIN */
.main { position: relative; z-index: 1; max-width: 780px; margin: 0 auto; padding: 56px 24px 80px; }

/* HERO */
.hero { margin-bottom: 52px; }
.hero-label {
  display: inline-flex; align-items: center; gap: 8px;
  font-family: var(--mono); font-size: 10px; color: var(--cyan);
  letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 18px;
  padding: 5px 12px; border: 1px solid rgba(79,195,247,0.25);
  border-radius: 100px; background: rgba(79,195,247,0.05);
}
.hero-label span { width: 5px; height: 5px; border-radius: 50%; background: var(--cyan); animation: blink 1.2s infinite; }
.hero h1 { font-size: clamp(36px,7vw,62px); font-weight: 700; line-height: 1.05; letter-spacing: -0.02em; color: var(--accent); margin-bottom: 16px; }
.hero h1 em { color: var(--cyan); font-style: normal; }
.hero p { font-size: 15px; color: var(--muted); max-width: 500px; line-height: 1.7; }

/* STEP LABELS */
.step-label { font-family: var(--mono); font-size: 10px; color: var(--cyan); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 10px; opacity: 0.7; }

/* UPLOAD */
.upload-area {
  position: relative; margin-bottom: 20px;
  border: 1.5px dashed var(--border2); border-radius: 12px;
  padding: 52px 32px; text-align: center; cursor: pointer;
  background: var(--surface);
  transition: border-color 0.25s, background 0.25s, box-shadow 0.25s; overflow: hidden;
}
.upload-area::after {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(ellipse at 50% 0%, rgba(79,195,247,0.05) 0%, transparent 70%);
  opacity: 0; transition: opacity 0.3s;
}
.upload-area:hover, .upload-area.drag-over { border-color: var(--cyan); background: rgba(79,195,247,0.03); box-shadow: 0 0 30px rgba(79,195,247,0.08); }
.upload-area:hover::after, .upload-area.drag-over::after { opacity: 1; }
.upload-area.has-file { border-style: solid; border-color: rgba(79,195,247,0.4); }
.upload-area input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.upload-icon { font-size: 44px; margin-bottom: 14px; }
.upload-area h3 { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
.upload-area p  { font-size: 13px; color: var(--muted); font-family: var(--mono); }
.file-chip { display: none; margin-top: 14px; font-family: var(--mono); font-size: 12px; color: var(--cyan); background: rgba(79,195,247,0.1); border: 1px solid rgba(79,195,247,0.2); padding: 6px 14px; border-radius: 100px; }

/* CARD */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 28px; margin-bottom: 20px; }
.card-title { font-size: 11px; font-weight: 700; color: var(--cyan); letter-spacing: 0.2em; margin-bottom: 22px; text-transform: uppercase; font-family: var(--mono); opacity: 0.8; }

/* TOGGLE */
.toggle-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 20px; }
.toggle-info .tlabel { font-size: 15px; font-weight: 700; color: var(--accent); }
.toggle-info .tdesc  { font-size: 12px; color: var(--muted); margin-top: 4px; font-family: var(--mono); line-height: 1.6; max-width: 380px; }
.toggle-switch { flex-shrink: 0; width: 46px; height: 24px; background: var(--border2); border-radius: 100px; border: none; cursor: pointer; position: relative; transition: background 0.25s; outline: none; }
.toggle-switch::after { content: ''; position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; border-radius: 50%; background: var(--muted); transition: transform 0.25s, background 0.25s; }
.toggle-switch.active { background: rgba(79,195,247,0.25); }
.toggle-switch.active::after { transform: translateX(22px); background: var(--cyan); }
.audio-extra { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
.audio-extra.show { display: block; }
.audio-pick { position: relative; display: flex; align-items: center; gap: 14px; padding: 14px 18px; background: var(--bg); border: 1px dashed var(--border2); border-radius: var(--r); cursor: pointer; width: 100%; transition: border-color 0.2s; font-family: var(--sans); color: var(--text); }
.audio-pick:hover { border-color: var(--cyan); }
.audio-pick input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.audio-pick .ap-icon { font-size: 22px; }
.audio-pick .ap-lbl { font-size: 14px; font-weight: 700; color: var(--accent); }
.audio-pick .ap-sub { font-size: 11px; color: var(--muted); font-family: var(--mono); margin-top: 2px; }
#audioName { display: none; margin-top: 10px; font-family: var(--mono); font-size: 11px; color: var(--cyan); }

/* SLIDERS */
.settings-grid { display: grid; gap: 24px; }
.slider-row { display: flex; flex-direction: column; gap: 8px; }
.slider-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.slider-lbl  { font-size: 14px; font-weight: 700; color: var(--accent); }
.slider-desc { font-size: 11px; color: var(--muted); font-family: var(--mono); margin-top: 2px; }
.slider-val  { font-family: var(--mono); font-size: 14px; color: var(--cyan); flex-shrink: 0; min-width: 16px; text-align: right; }
input[type=range] {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 3px; background: var(--border2);
  border-radius: 100px; outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
  background: var(--cyan); cursor: pointer;
  box-shadow: 0 0 6px rgba(79,195,247,0.5); transition: box-shadow 0.2s;
}
input[type=range]::-webkit-slider-thumb:hover { box-shadow: 0 0 14px rgba(79,195,247,0.9); }
input[type=range]::-moz-range-thumb {
  width: 16px; height: 16px; border-radius: 50%; border: none;
  background: var(--cyan); cursor: pointer; box-shadow: 0 0 6px rgba(79,195,247,0.5);
}

/* CONVERT BUTTON */
#convertBtn {
  width: 100%; padding: 19px;
  background: var(--surface2); border: 1.5px solid var(--border2);
  border-radius: var(--r); color: var(--accent);
  font-family: var(--sans); font-size: 17px; font-weight: 700;
  letter-spacing: 0.06em; text-transform: uppercase;
  cursor: pointer; position: relative; overflow: hidden;
  transition: border-color 0.25s, box-shadow 0.25s, background 0.25s;
  margin-bottom: 28px;
}
#convertBtn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(79,195,247,0.08), transparent); transform: translateX(-100%); transition: transform 0.7s; }
#convertBtn:not(:disabled):hover::before { transform: translateX(100%); }
#convertBtn:not(:disabled):hover { border-color: var(--cyan); box-shadow: 0 0 30px rgba(79,195,247,0.15), 0 4px 20px rgba(0,0,0,0.4); background: rgba(79,195,247,0.05); }
#convertBtn:disabled { opacity: 0.3; cursor: not-allowed; }

/* PROGRESS */
#progressSection { display: none; margin-bottom: 28px; }
#progressSection.show { display: block; }
.prog-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
.prog-label { font-family: var(--mono); font-size: 11px; color: var(--cyan); }
.prog-pct   { font-family: var(--mono); font-size: 13px; color: var(--accent); }
.prog-track { height: 2px; background: var(--border); border-radius: 100px; overflow: hidden; margin-bottom: 16px; }
.prog-fill  { height: 100%; width: 0%; background: var(--cyan); border-radius: 100px; box-shadow: 0 0 8px var(--cyan); transition: width 0.3s ease; }
.prog-steps { display: flex; gap: 8px; flex-wrap: wrap; }
.pchip { font-family: var(--mono); font-size: 10px; padding: 3px 10px; border-radius: 100px; border: 1px solid var(--border2); color: var(--muted); transition: all 0.3s; letter-spacing: 0.05em; }
.pchip.active { border-color: var(--cyan); color: var(--cyan); background: rgba(79,195,247,0.1); }
.pchip.done   { border-color: transparent; color: var(--border2); }

/* RESULT */
#resultSection { display: none; }
#resultSection.show { display: block; }
.result-card { background: #000; border: 1px solid var(--border2); border-radius: 12px; overflow: hidden; box-shadow: 0 0 40px rgba(79,195,247,0.08); }
.result-card video { width: 100%; display: block; max-height: 480px; object-fit: contain; background: #000; }
.result-actions { display: flex; gap: 12px; padding: 20px 24px; border-top: 1px solid var(--border); flex-wrap: wrap; }
.btn-primary   { flex: 1; min-width: 160px; padding: 13px 20px; background: var(--cyan); color: #050c14; border: none; border-radius: var(--r); font-family: var(--sans); font-size: 14px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: opacity 0.2s, transform 0.2s; }
.btn-primary:hover { opacity: 0.88; transform: translateY(-1px); }
.btn-secondary { flex: 1; min-width: 160px; padding: 13px 20px; background: transparent; color: var(--muted); border: 1px solid var(--border2); border-radius: var(--r); font-family: var(--sans); font-size: 14px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; transition: border-color 0.2s, color 0.2s; }
.btn-secondary:hover { border-color: var(--accent); color: var(--text); }

/* NOTICE */
.notice { display: flex; gap: 10px; align-items: flex-start; padding: 12px 16px; background: rgba(105,240,174,0.04); border: 1px solid rgba(105,240,174,0.12); border-radius: var(--r); margin-bottom: 20px; font-size: 12px; color: var(--muted); font-family: var(--mono); line-height: 1.6; }
.notice .ni { color: var(--green); flex-shrink: 0; }

/* MOBILE */
body.mobile-mode header { padding: 14px 16px; }
body.mobile-mode .main  { padding: 32px 16px 60px; }
body.mobile-mode .hero h1 { font-size: 34px; }
body.mobile-mode .upload-area { padding: 40px 20px; }
body.mobile-mode .card  { padding: 20px 16px; }
body.mobile-mode .result-actions { flex-direction: column; }
body.mobile-mode .btn-primary, body.mobile-mode .btn-secondary { width: 100%; flex: none; }
body.mobile-mode .device-popup { padding: 36px 20px 28px; }
body.mobile-mode .dl-popup { padding: 28px 18px 20px; }
</style>
</head>
<body>

<!-- DEVICE POPUP -->
<div id="deviceOverlay">
  <div class="device-popup">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
    <div class="popup-eyebrow">// SYSTEM INIT</div>
    <h2>hey! i just need you to answer this real quick,<br>this WILL CHANGE how you view the site!</h2>
    <div class="dsub">select your device to continue_</div>
    <button class="device-btn" onclick="chooseDevice('pc')">
      <span class="icon">ğŸ–¥ï¸</span>
      <div><div class="dlbl">PC / Laptop</div><div class="ddesc">full desktop experience</div></div>
    </button>
    <button class="device-btn" onclick="chooseDevice('mobile')">
      <span class="icon">ğŸ“±</span>
      <div><div class="dlbl">Mobile Device</div><div class="ddesc">touch-optimized layout</div></div>
    </button>
  </div>
</div>

<!-- DOWNLOAD POPUP -->
<div id="dlOverlay" onclick="if(event.target===this)closeDl()">
  <div class="dl-popup">
    <h3>Download Video</h3>
    <div class="dlsub">// webm plays in chrome, firefox, edge, safari 16+</div>
    <button class="dl-opt" onclick="doDownload()">
      <span class="fmt">.WEBM</span>
      <div><div class="fo-lbl">WebM â€” VP8/VP9 + Opus</div><div class="fo-desc">web-optimized Â· full audio Â· universal modern browser</div></div>
    </button>
    <button class="dl-cancel" onclick="closeDl()">Cancel</button>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo"><div class="logo-pulse"></div>VFX<span style="color:var(--cyan)">AI</span></div>
  <div class="header-tag">NODE GRAPH OVERLAY v2.0</div>
</header>

<main class="main">

  <div class="hero">
    <div class="hero-label"><span></span> AI MOTION ANALYSIS</div>
    <h1>Make Your<br>Video <em>Cool</em></h1>
    <p>Upload any video and watch AI overlay a live neural-graph tracking network â€” nodes spawn on moving areas, connected by glowing lines with floating labels.</p>
  </div>

  <div class="step-label">// 01 &nbsp; UPLOAD VIDEO</div>
  <div class="upload-area" id="uploadArea">
    <input type="file" id="videoInput" accept="video/mp4,video/quicktime,.mov,.mp4" />
    <div class="upload-icon">ğŸ“‚</div>
    <h3>Drop your video here</h3>
    <p>MP4 or MOV &nbsp;Â·&nbsp; any resolution</p>
    <div class="file-chip" id="fileChip"></div>
  </div>

  <div class="step-label">// 02 &nbsp; AUDIO (OPTIONAL)</div>
  <div class="card">
    <div class="card-title">// AUDIO SETTINGS</div>
    <div class="toggle-row">
      <div class="toggle-info">
        <div class="tlabel">Replace Audio Track</div>
        <div class="tdesc">Swap out the original audio with your own file â€” trimmed to match the video length. If off, the original audio is preserved.</div>
      </div>
      <button class="toggle-switch" id="audioToggle" onclick="toggleAudio()"></button>
    </div>
    <div class="audio-extra" id="audioExtra">
      <button class="audio-pick">
        <input type="file" id="audioInput" accept="audio/*" onchange="onAudioPick()" />
        <span class="ap-icon">ğŸµ</span>
        <div><div class="ap-lbl">Upload Audio Track</div><div class="ap-sub">MP3 Â· WAV Â· AAC Â· OGG</div></div>
      </button>
      <div id="audioName"></div>
    </div>
  </div>

  <div class="step-label">// 03 &nbsp; EFFECT SETTINGS</div>
  <div class="card">
    <div class="card-title">// OVERLAY PARAMETERS &nbsp;Â·&nbsp; 0 = off &nbsp;Â·&nbsp; default = 1 &nbsp;Â·&nbsp; max = 5</div>
    <div class="settings-grid">

      <div class="slider-row">
        <div class="slider-header">
          <div><div class="slider-lbl">Movement Sensitivity</div><div class="slider-desc">how much motion triggers nodes â€” higher = more nodes spawned</div></div>
          <div class="slider-val" id="valSens">1</div>
        </div>
        <input type="range" id="slSens" min="0" max="5" step="1" value="1" oninput="syncSlider('Sens')" />
      </div>

      <div class="slider-row">
        <div class="slider-header">
          <div><div class="slider-lbl">Line Thickness</div><div class="slider-desc">stroke width of connecting lines and node rectangles</div></div>
          <div class="slider-val" id="valThick">1</div>
        </div>
        <input type="range" id="slThick" min="0" max="5" step="1" value="1" oninput="syncSlider('Thick')" />
      </div>

      <div class="slider-row">
        <div class="slider-header">
          <div><div class="slider-lbl">Line Glow</div><div class="slider-desc">bloom / glow radius around lines and node markers</div></div>
          <div class="slider-val" id="valGlow">1</div>
        </div>
        <input type="range" id="slGlow" min="0" max="5" step="1" value="1" oninput="syncSlider('Glow')" />
      </div>

      <div class="slider-row">
        <div class="slider-header">
          <div><div class="slider-lbl">Line Imperfections</div><div class="slider-desc">adds organic curve and wobble â€” 0 = straight lines, 5 = wild curves</div></div>
          <div class="slider-val" id="valImp">1</div>
        </div>
        <input type="range" id="slImp" min="0" max="5" step="1" value="1" oninput="syncSlider('Imp')" />
      </div>

    </div>
  </div>

  <div class="step-label">// 04 &nbsp; PROCESS</div>
  <div class="notice">
    <span class="ni">â„¹</span>
    <span>Processing runs in real-time in your browser â€” a 30s video takes ~30s to process. Nothing is uploaded anywhere. Best in Chrome or Edge. Output is WebM with original audio.</span>
  </div>
  <button id="convertBtn" disabled onclick="startConvert()">â¬¡ &nbsp; Make My Video Cool</button>

  <div id="progressSection">
    <div class="prog-header">
      <span class="prog-label" id="progLabel">initializing...</span>
      <span class="prog-pct"   id="progPct">0%</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-steps">
      <div class="pchip" id="c1">DECODE</div>
      <div class="pchip" id="c2">ANALYZE</div>
      <div class="pchip" id="c3">OVERLAY</div>
      <div class="pchip" id="c4">ENCODE</div>
    </div>
  </div>

  <div id="resultSection">
    <div class="step-label" style="margin-bottom:14px;">// DONE â€” PREVIEW &amp; DOWNLOAD</div>
    <div class="result-card">
      <video id="resultVideo" controls playsinline></video>
    </div>
    <div class="result-actions">
      <button class="btn-primary"   onclick="openDl()">â¬‡ &nbsp; Download</button>
      <button class="btn-secondary" onclick="resetAll()">â†© &nbsp; Convert Another</button>
    </div>
  </div>

</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEVICE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function chooseDevice(t) {
  document.getElementById('deviceOverlay').classList.add('hidden');
  if (t === 'mobile') document.body.classList.add('mobile-mode');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLIDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncSlider(k) {
  document.getElementById('val' + k).textContent = document.getElementById('sl' + k).value;
}
function getSettings() {
  return {
    sensitivity: +document.getElementById('slSens').value,
    thickness:   +document.getElementById('slThick').value,
    glow:        +document.getElementById('slGlow').value,
    imperfect:   +document.getElementById('slImp').value,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let videoFile = null, audioFile = null, resultBlob = null, audioOn = false;
const videoInput = document.getElementById('videoInput');
const uploadArea = document.getElementById('uploadArea');
const fileChip   = document.getElementById('fileChip');
const convertBtn = document.getElementById('convertBtn');

uploadArea.addEventListener('dragover',  e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', ()  => uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault(); uploadArea.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) setVid(e.dataTransfer.files[0]);
});
videoInput.addEventListener('change', () => { if (videoInput.files[0]) setVid(videoInput.files[0]); });

function setVid(f) {
  videoFile = f;
  uploadArea.classList.add('has-file');
  fileChip.style.display = 'inline-block';
  fileChip.textContent = 'âœ“ ' + f.name;
  convertBtn.disabled = false;
}
function toggleAudio() {
  audioOn = !audioOn;
  document.getElementById('audioToggle').classList.toggle('active', audioOn);
  document.getElementById('audioExtra').classList.toggle('show', audioOn);
}
function onAudioPick() {
  const f = document.getElementById('audioInput').files[0];
  if (!f) return;
  audioFile = f;
  const el = document.getElementById('audioName');
  el.style.display = 'block';
  el.textContent = 'âœ“ ' + f.name;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setProgress(pct, label, step) {
  document.getElementById('progFill').style.width  = pct + '%';
  document.getElementById('progPct').textContent   = Math.round(pct) + '%';
  document.getElementById('progLabel').textContent = label;
  ['c1','c2','c3','c4'].forEach((id, i) => {
    const el = document.getElementById(id);
    el.className = 'pchip' + (i < step ? ' done' : i === step ? ' active' : '');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONVERT ENTRY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startConvert() {
  if (!videoFile) return;
  convertBtn.disabled = true;
  document.getElementById('resultSection').classList.remove('show');
  document.getElementById('progressSection').classList.add('show');
  setProgress(2, 'loading video...', 0);
  try {
    resultBlob = await processVideo(videoFile, audioOn ? audioFile : null, getSettings());
    setProgress(100, 'complete!', 4);
    await new Promise(r => setTimeout(r, 350));
    showResult(resultBlob);
  } catch(err) {
    console.error(err);
    setProgress(0, 'error â€” ' + err.message, 0);
    convertBtn.disabled = false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORE ENGINE
   Key fix: play video in real-time + requestAnimationFrame.
   This produces proper 30fps output instead of 1fps.
   Audio is captured via AudioContext â†’ MediaStreamDestination.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function processVideo(srcFile, replaceAudioFile, S) {
  const srcURL = URL.createObjectURL(srcFile);

  /* Source video â€” visual, muted (audio handled separately) */
  const vid = document.createElement('video');
  vid.src = srcURL; vid.muted = true; vid.playsInline = true;
  await waitMeta(vid);
  const W = vid.videoWidth, H = vid.videoHeight, duration = vid.duration;

  /* Output canvas */
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  /* Off-screen diff canvas */
  const offC = document.createElement('canvas');
  offC.width = W; offC.height = H;
  const offCtx = offC.getContext('2d', { willReadFrequently: true });

  /* â”€â”€ Audio routing â”€â”€ */
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const actx = new AudioCtx();
  const audioDest = actx.createMediaStreamDestination();

  let audioSourceEl = null;

  if (replaceAudioFile) {
    /* Replacement audio file */
    audioSourceEl = document.createElement('audio');
    audioSourceEl.src = URL.createObjectURL(replaceAudioFile);
    audioSourceEl.crossOrigin = 'anonymous';
    await waitMeta(audioSourceEl);
  } else {
    /* Original video audio â€” use a second parallel video element */
    audioSourceEl = document.createElement('video');
    audioSourceEl.src = srcURL;
    audioSourceEl.muted = false;
    audioSourceEl.playsInline = true;
    audioSourceEl.crossOrigin = 'anonymous';
    await waitMeta(audioSourceEl);
  }

  /* Connect audio element into AudioContext â†’ capture destination */
  try {
    const audioSrc = actx.createMediaElementSource(audioSourceEl);
    audioSrc.connect(audioDest);
    /* Don't connect to actx.destination â€” we don't need to hear it */
  } catch(e) {
    console.warn('Audio source connect failed:', e);
  }

  /* â”€â”€ Combined stream: canvas video + audio capture â”€â”€ */
  const mime = getBestMime();
  const canvasStream = canvas.captureStream(30);
  const combined = new MediaStream([
    ...canvasStream.getVideoTracks(),
    ...audioDest.stream.getAudioTracks(),
  ]);

  const chunks = [];
  const recorder = new MediaRecorder(combined, { mimeType: mime, videoBitsPerSecond: 10_000_000 });
  recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
  recorder.start(200);

  /* â”€â”€ Motion state â”€â”€ */
  let prevLuma = null;
  let nodes = [];
  let idCounter = 0;

  setProgress(5, 'starting playback...', 0);

  /* â”€â”€ Play & frame loop â”€â”€ */
  await new Promise((resolve, reject) => {
    let raf = null;

    function drawFrame() {
      if (vid.paused || vid.ended) return;

      /* Draw source frame to output canvas */
      ctx.drawImage(vid, 0, 0, W, H);

      /* Luma diff for motion */
      offCtx.drawImage(vid, 0, 0, W, H);
      const id = offCtx.getImageData(0, 0, W, H);
      const luma = toLuma(id.data, W, H);

      if (prevLuma) {
        const spots = findSpots(luma, prevLuma, W, H, S.sensitivity);
        idCounter = spawnNodes(nodes, spots, idCounter, S);
        ageNodes(nodes, luma, prevLuma, W);
        drawGraph(ctx, nodes, W, H, S);
        nodes = nodes.filter(n => n.life > 0.01);
      }
      prevLuma = luma;

      const pct = 5 + (vid.currentTime / duration) * 88;
      const step = vid.currentTime < duration * 0.3 ? 1 : vid.currentTime < duration * 0.75 ? 2 : 3;
      setProgress(pct, `processing ${fmt(vid.currentTime)} / ${fmt(duration)}`, step);

      raf = requestAnimationFrame(drawFrame);
    }

    vid.addEventListener('play',  () => { raf = requestAnimationFrame(drawFrame); }, { once: true });
    vid.addEventListener('ended', () => { if (raf) cancelAnimationFrame(raf); resolve(); });
    vid.addEventListener('error', reject);

    /* Start visual + audio in sync */
    const playPromises = [vid.play()];
    if (audioSourceEl) {
      audioSourceEl.currentTime = 0;
      playPromises.push(audioSourceEl.play().catch(() => {}));
    }
    Promise.all(playPromises).catch(reject);
  });

  /* â”€â”€ Finalize â”€â”€ */
  if (audioSourceEl) audioSourceEl.pause();
  setProgress(94, 'encoding...', 3);
  recorder.stop();
  await new Promise(r => { recorder.onstop = r; });

  if (chunks.length === 0) {
    throw new Error('No data captured â€” try Chrome or Edge for best results.');
  }
  return new Blob(chunks, { type: mime });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOTION â€” FIND HOTSPOTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toLuma(data, W, H) {
  const out = new Float32Array(W * H);
  for (let i = 0; i < W * H; i++) {
    const p = i * 4;
    out[i] = 0.299 * data[p] + 0.587 * data[p+1] + 0.114 * data[p+2];
  }
  return out;
}

function findSpots(luma, prev, W, H, sensitivity) {
  /* Threshold: 0=very high (barely any), 5=very low (everything) */
  const thresh = [52, 36, 26, 18, 12, 8][sensitivity] ?? 36;
  const GRID = 14;
  const cw = Math.floor(W / GRID), ch = Math.floor(H / GRID);
  const cells = [];
  for (let gy = 0; gy < GRID; gy++) {
    for (let gx = 0; gx < GRID; gx++) {
      let sum = 0, cnt = 0;
      const x0 = gx * cw, y0 = gy * ch;
      for (let py = y0, y1 = Math.min(y0+ch,H); py < y1; py += 3) {
        for (let px = x0, x1 = Math.min(x0+cw,W); px < x1; px += 3) {
          sum += Math.abs(luma[py * W + px] - prev[py * W + px]);
          cnt++;
        }
      }
      const avg = sum / cnt;
      if (avg > thresh) cells.push({ x: x0 + cw/2, y: y0 + ch/2, score: avg });
    }
  }
  cells.sort((a,b) => b.score - a.score);
  /* Max active nodes scales with sensitivity */
  const maxN = [5, 9, 13, 18, 24, 32][sensitivity] ?? 9;
  return cells.slice(0, maxN);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NODE MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LABELS = [
  () => '0x' + Math.floor(Math.random()*256).toString(16).toUpperCase().padStart(2,'0'),
  () => (Math.random()*9.9+0.1).toFixed(1),
  () => 'var_' + Math.floor(Math.random()*0xFF).toString(16),
  () => Math.floor(Math.random()*999).toString(),
];

function spawnNodes(nodes, spots, idCounter, S) {
  const MINDIST2 = 55 * 55;
  for (const sp of spots) {
    let found = false;
    for (const n of nodes) {
      const dx = n.x-sp.x, dy = n.y-sp.y;
      if (dx*dx+dy*dy < MINDIST2) { n.life = Math.min(1, n.life+0.15); found=true; break; }
    }
    if (!found) {
      nodes.push({
        id: idCounter++,
        x: sp.x, y: sp.y,
        life: 0.9,
        label: LABELS[Math.floor(Math.random()*LABELS.length)](),
        seed: Math.random() * 999,
      });
    }
  }
  return idCounter;
}

function ageNodes(nodes, luma, prev, W) {
  const t = performance.now() * 0.001;
  for (const n of nodes) {
    n.life -= 0.025;
    /* Small organic drift */
    n.x += Math.sin(n.seed + t) * 0.3;
    n.y += Math.cos(n.seed * 1.3 + t) * 0.3;
    /* Refresh if still in motion zone */
    const xi = Math.max(0, Math.min(W-1, Math.round(n.x)));
    const yi = Math.max(0, Math.round(n.y));
    const idx = yi * W + xi;
    if (idx >= 0 && idx < luma.length && Math.abs(luma[idx] - prev[idx]) > 20) {
      n.life = Math.min(1, n.life + 0.03);
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW NODE GRAPH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawGraph(ctx, nodes, W, H, S) {
  const live = nodes.filter(n => n.life > 0.05);
  if (live.length < 2) return;

  /* Map 0-5 settings to real values */
  const LW  = [0.0, 0.8, 1.5, 2.2, 3.0, 4.0][S.thickness]  ?? 0.8;
  const GLO = [0,   5,   11,  18,  26,  36 ][S.glow]        ?? 5;
  const IMP = [0,   14,  30,  55,  90,  140][S.imperfect]   ?? 14;
  const now = performance.now();

  ctx.save();

  /* â”€â”€ Lines: full mesh (every node to every node) â”€â”€ */
  for (let i = 0; i < live.length; i++) {
    for (let j = i+1; j < live.length; j++) {
      const a = live[i], b = live[j];
      const alpha = Math.min(a.life, b.life) * 0.8;
      if (alpha < 0.05) continue;

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(0.3, LW);
      if (GLO > 0) { ctx.shadowBlur = GLO; ctx.shadowColor = 'rgba(200,230,255,0.95)'; }

      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      if (IMP > 0) {
        const cpx = (a.x+b.x)/2 + Math.sin((a.seed+b.seed)*0.5 + now*0.0007) * IMP;
        const cpy = (a.y+b.y)/2 + Math.cos((a.seed+b.seed)*0.7 + now*0.0009) * IMP;
        ctx.quadraticCurveTo(cpx, cpy, b.x, b.y);
      } else {
        ctx.lineTo(b.x, b.y);
      }
      ctx.stroke();
      ctx.restore();
    }
  }

  /* â”€â”€ Nodes: rectangles + dot + label â”€â”€ */
  const RW = Math.max(0, LW) * 0 + 7; /* fixed rect size, independent of thickness */
  for (const n of live) {
    ctx.save();
    ctx.globalAlpha = n.life;
    if (GLO > 0) { ctx.shadowBlur = GLO * 1.3; ctx.shadowColor = 'rgba(200,235,255,0.98)'; }

    /* Rectangle marker */
    if (LW > 0) {
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(0.7, LW * 0.65);
      ctx.strokeRect(n.x - RW, n.y - RW * 0.65, RW * 2, RW * 1.3);
    }

    /* Center dot */
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.beginPath();
    ctx.arc(n.x, n.y, Math.max(1.2, LW * 0.8 + 0.5), 0, Math.PI*2);
    ctx.fill();

    /* Floating label */
    if (GLO > 0) { ctx.shadowBlur = GLO * 0.6; ctx.shadowColor = 'rgba(200,235,255,0.7)'; }
    ctx.font = '9px "Share Tech Mono", monospace';
    ctx.fillStyle = 'rgba(205,230,255,0.8)';
    ctx.fillText(n.label, n.x - RW, n.y - RW - 4);
    ctx.restore();
  }

  ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function waitMeta(el) {
  return new Promise((res, rej) => {
    if (el.readyState >= 1) { res(); return; }
    el.onloadedmetadata = res; el.onerror = rej; el.load();
  });
}

function getBestMime() {
  const types = [
    'video/webm;codecs=vp9,opus',
    'video/webm;codecs=vp8,opus',
    'video/webm;codecs=vp9',
    'video/webm;codecs=vp8',
    'video/webm',
  ];
  return types.find(t => MediaRecorder.isTypeSupported(t)) || 'video/webm';
}

function fmt(s) {
  return Math.floor(s/60) + ':' + String(Math.floor(s%60)).padStart(2,'0');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULT + DOWNLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResult(blob) {
  document.getElementById('resultVideo').src = URL.createObjectURL(blob);
  document.getElementById('progressSection').classList.remove('show');
  document.getElementById('resultSection').classList.add('show');
  document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  convertBtn.disabled = false;
}

function openDl()  { document.getElementById('dlOverlay').classList.add('open'); }
function closeDl() { document.getElementById('dlOverlay').classList.remove('open'); }

function doDownload() {
  if (!resultBlob) return;
  closeDl();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(resultBlob);
  a.download = 'vfxai-output.webm';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function resetAll() {
  videoFile = null; audioFile = null; resultBlob = null; audioOn = false;
  videoInput.value = '';
  document.getElementById('audioInput').value = '';
  document.getElementById('audioName').style.display = 'none';
  document.getElementById('audioToggle').classList.remove('active');
  document.getElementById('audioExtra').classList.remove('show');
  uploadArea.classList.remove('has-file');
  fileChip.style.display = 'none';
  document.getElementById('progressSection').classList.remove('show');
  document.getElementById('resultSection').classList.remove('show');
  document.getElementById('resultVideo').src = '';
  convertBtn.disabled = true;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>
