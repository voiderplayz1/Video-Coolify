<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VizFX ‚Äî Make Your Video Cool</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a25;
    --border: rgba(255,255,255,0.08);
    --accent: #00e5ff;
    --accent2: #7b2fff;
    --text: #f0f0f8;
    --muted: #6b6b85;
    --danger: #ff4060;
    --success: #00e5a0;
    --radius: 12px;
    --device: 'pc';
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ NOISE TEXTURE ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0; opacity: 0.4;
  }

  /* ‚îÄ‚îÄ DEVICE POPUP ‚îÄ‚îÄ */
  .popup-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.92);
    backdrop-filter: blur(12px);
    z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .popup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 48px 40px;
    max-width: 460px;
    width: 90%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .popup-card::before {
    content: '';
    position: absolute;
    top: -80px; left: 50%; transform: translateX(-50%);
    width: 300px; height: 200px;
    background: radial-gradient(ellipse, rgba(0,229,255,0.15) 0%, transparent 70%);
    pointer-events: none;
  }

  .popup-emoji { font-size: 36px; margin-bottom: 16px; display: block; }

  .popup-card h2 {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    line-height: 1.4;
    margin-bottom: 8px;
  }

  .popup-card h2 span { color: var(--accent); }

  .popup-subtitle {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 32px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .device-options { display: flex; flex-direction: column; gap: 12px; }

  .device-btn {
    display: flex; align-items: center; gap: 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 24px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
    color: var(--text);
    font-family: 'DM Mono', monospace;
  }

  .device-btn:hover {
    border-color: var(--accent);
    background: rgba(0,229,255,0.05);
    transform: translateY(-2px);
  }

  .device-btn .icon { font-size: 28px; }

  .device-btn .label { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; }
  .device-btn .sublabel { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  .app {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 80px;
    position: relative; z-index: 1;
  }

  /* PC Layout */
  body.pc .app { max-width: 900px; }

  /* Mobile Layout */
  body.mobile .app { max-width: 480px; padding: 20px 16px 60px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 48px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 22px;
    letter-spacing: -0.02em;
  }

  .logo span { color: var(--accent); }

  .logo-tag {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-top: 2px;
  }

  .device-indicator {
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 100px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .device-indicator:hover { border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero {
    margin-bottom: 40px;
  }

  .hero h1 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: clamp(28px, 5vw, 52px);
    line-height: 1.1;
    letter-spacing: -0.03em;
    margin-bottom: 12px;
  }

  .hero h1 .accent { color: var(--accent); }
  .hero h1 .accent2 { color: var(--accent2); }

  .hero p {
    color: var(--muted);
    font-size: 13px;
    max-width: 480px;
    line-height: 1.7;
  }

  /* ‚îÄ‚îÄ STEPS ‚îÄ‚îÄ */
  .steps {
    display: grid;
    gap: 16px;
    margin-bottom: 32px;
  }

  body.pc .steps { grid-template-columns: 1fr 1fr; }
  body.mobile .steps { grid-template-columns: 1fr; }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: rgba(0,229,255,0.2); }

  .card-num {
    font-size: 10px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 12px;
    font-weight: 500;
  }

  .card h3 {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 16px;
  }

  /* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
  .upload-zone {
    border: 1.5px dashed var(--border);
    border-radius: var(--radius);
    padding: 32px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: rgba(255,255,255,0.01);
    position: relative;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .upload-zone input[type="file"] {
    position: absolute; inset: 0;
    opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .upload-icon { font-size: 32px; margin-bottom: 8px; }
  .upload-label { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .upload-sub { font-size: 11px; color: var(--muted); }

  .file-info {
    display: flex; align-items: center; gap: 10px;
    background: rgba(0,229,255,0.07);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 12px;
    margin-top: 12px;
  }

  .file-info .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-info .remove { color: var(--danger); cursor: pointer; font-size: 16px; flex-shrink: 0; }

  /* ‚îÄ‚îÄ EFFECT OPTIONS ‚îÄ‚îÄ */
  .effect-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }

  .effect-option {
    display: flex; flex-direction: column; align-items: center;
    padding: 14px 8px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 11px;
    text-align: center;
    gap: 6px;
    color: var(--muted);
  }

  .effect-option .eff-icon { font-size: 20px; }

  .effect-option:hover { border-color: var(--accent2); color: var(--text); }

  .effect-option.active {
    border-color: var(--accent);
    background: rgba(0,229,255,0.06);
    color: var(--text);
  }

  .effect-option.active .eff-icon { filter: drop-shadow(0 0 6px var(--accent)); }

  /* ‚îÄ‚îÄ AUDIO SECTION ‚îÄ‚îÄ */
  .toggle-wrap {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
  }

  .toggle-label { font-size: 13px; font-weight: 500; }
  .toggle-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .toggle {
    position: relative;
    width: 44px; height: 24px;
    cursor: pointer;
  }

  .toggle input { opacity: 0; width: 0; height: 0; }

  .toggle-track {
    position: absolute; inset: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 100px;
    transition: 0.2s;
  }

  .toggle input:checked + .toggle-track {
    background: var(--accent);
    border-color: var(--accent);
  }

  .toggle-thumb {
    position: absolute;
    top: 3px; left: 3px;
    width: 16px; height: 16px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
    pointer-events: none;
  }

  .toggle input:checked ~ .toggle-thumb { left: 23px; }

  .audio-upload-section {
    display: none;
    margin-top: 12px;
  }

  .audio-upload-section.visible { display: block; }

  /* ‚îÄ‚îÄ CTA BUTTON ‚îÄ‚îÄ */
  .cta-wrap { margin-top: 24px; }

  .cta-btn {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: var(--radius);
    padding: 18px 32px;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.01em;
  }

  .cta-btn::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.4s;
  }

  .cta-btn:hover::before { transform: translateX(100%); }
  .cta-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,229,255,0.35); }
  .cta-btn:active { transform: translateY(0); }
  .cta-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
  .progress-wrap {
    margin-top: 20px;
    display: none;
  }

  .progress-wrap.visible { display: block; }

  .progress-bar {
    height: 4px;
    background: var(--surface2);
    border-radius: 100px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 100px;
    transition: width 0.2s ease;
    width: 0%;
  }

  .progress-text { font-size: 11px; color: var(--muted); text-align: center; }

  /* ‚îÄ‚îÄ PREVIEW SECTION ‚îÄ‚îÄ */
  .preview-section {
    margin-top: 32px;
    display: none;
  }

  .preview-section.visible { display: block; }

  .preview-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
  }

  .preview-header h3 {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 16px;
  }

  .preview-header .badge {
    font-size: 10px;
    background: rgba(0,229,160,0.1);
    color: var(--success);
    border: 1px solid rgba(0,229,160,0.3);
    padding: 4px 10px;
    border-radius: 100px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .video-preview {
    width: 100%;
    border-radius: 12px;
    background: #000;
    display: block;
    border: 1px solid var(--border);
    max-height: 400px;
  }

  .download-btn {
    margin-top: 16px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 24px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text);
  }

  .download-btn:hover {
    border-color: var(--success);
    color: var(--success);
    background: rgba(0,229,160,0.05);
  }

  /* ‚îÄ‚îÄ DOWNLOAD POPUP ‚îÄ‚îÄ */
  .dl-popup-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 9998;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.2s ease;
  }

  .dl-popup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 36px 32px;
    max-width: 380px;
    width: 90%;
    text-align: center;
  }

  .dl-popup-card h3 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 20px;
    margin-bottom: 8px;
  }

  .dl-popup-card p { font-size: 12px; color: var(--muted); margin-bottom: 28px; }

  .dl-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }

  .dl-option {
    display: flex; align-items: center; gap: 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    width: 100%;
  }

  .dl-option:hover { border-color: var(--accent); background: rgba(0,229,255,0.05); }

  .dl-option .fmt { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px; color: var(--accent); width: 52px; flex-shrink: 0; }
  .dl-option .dl-info .dl-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
  .dl-option .dl-info .dl-sub { font-size: 11px; color: var(--muted); }

  .dl-cancel {
    font-size: 12px; color: var(--muted);
    cursor: pointer; background: none; border: none; font-family: 'DM Mono', monospace;
    transition: color 0.2s;
  }

  .dl-cancel:hover { color: var(--text); }

  /* ‚îÄ‚îÄ CANVAS (hidden processing) ‚îÄ‚îÄ */
  #processCanvas, #inputVideo { display: none; }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }

  .app { animation: slideUp 0.5s ease 0.1s both; }

  /* ‚îÄ‚îÄ MOBILE SPECIFIC ‚îÄ‚îÄ */
  body.mobile .hero h1 { font-size: 32px; }
  body.mobile header { margin-bottom: 28px; }
  body.mobile .card { padding: 18px; }
  body.mobile .effect-grid { grid-template-columns: 1fr 1fr; }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    text-align: center;
    margin-top: 60px;
    font-size: 11px;
    color: var(--muted);
    border-top: 1px solid var(--border);
    padding-top: 24px;
  }

  footer span { color: var(--accent); }

  /* ‚îÄ‚îÄ STATUS INDICATOR ‚îÄ‚îÄ */
  .status-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--success);
    margin-right: 6px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }

</style>
</head>
<body>

<!-- DEVICE POPUP -->
<div class="popup-overlay" id="devicePopup">
  <div class="popup-card">
    <span class="popup-emoji">üëã</span>
    <h2>hey! i just need you to answer this <span>real quick</span></h2>
    <p class="popup-subtitle">this WILL CHANGE how you view the site!</p>
    <div class="device-options">
      <button class="device-btn" onclick="setDevice('pc')">
        <span class="icon">üñ•Ô∏è</span>
        <div>
          <div class="label">PC / Laptop</div>
          <div class="sublabel">Full desktop experience with expanded layout</div>
        </div>
      </button>
      <button class="device-btn" onclick="setDevice('mobile')">
        <span class="icon">üì±</span>
        <div>
          <div class="label">Mobile Device</div>
          <div class="sublabel">Optimized for touchscreens, same output quality</div>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- DOWNLOAD POPUP -->
<div class="dl-popup-overlay" id="dlPopup" style="display:none">
  <div class="dl-popup-card">
    <h3>‚¨áÔ∏è Download Your Video</h3>
    <p>Choose your preferred format below</p>
    <div class="dl-options">
      <button class="dl-option" onclick="downloadAs('mp4')">
        <span class="fmt">MP4</span>
        <div class="dl-info">
          <div class="dl-name">MPEG-4 Video</div>
          <div class="dl-sub">Best compatibility ‚Äî works everywhere</div>
        </div>
      </button>
      <button class="dl-option" onclick="downloadAs('webm')">
        <span class="fmt">WEBM</span>
        <div class="dl-info">
          <div class="dl-name">WebM Video</div>
          <div class="dl-sub">Smaller file size, great for web</div>
        </div>
      </button>
      <button class="dl-option" onclick="downloadAs('mov')">
        <span class="fmt">MOV</span>
        <div class="dl-info">
          <div class="dl-name">QuickTime Movie</div>
          <div class="dl-sub">Best for Apple devices & editing</div>
        </div>
      </button>
    </div>
    <button class="dl-cancel" onclick="closeDlPopup()">Cancel</button>
  </div>
</div>

<!-- PROCESSING ELEMENTS (HIDDEN) -->
<video id="inputVideo" muted playsinline></video>
<canvas id="processCanvas"></canvas>
<audio id="customAudio"></audio>

<div class="app" id="mainApp" style="opacity:0;pointer-events:none">

  <header>
    <div>
      <div class="logo">VIZ<span>FX</span></div>
      <div class="logo-tag"><span class="status-dot"></span>Video Effect Studio</div>
    </div>
    <div class="device-indicator" id="deviceIndicator" onclick="resetDevice()">üñ•Ô∏è PC ‚Äî tap to switch</div>
  </header>

  <div class="hero">
    <h1>Make Your<br><span class="accent">Video</span> <span class="accent2">Cool</span></h1>
    <p>Upload your clip and we'll apply real-time visual effects ‚Äî motion lines, detection boxes, scanlines and more ‚Äî right in your browser. No uploads to a server, ever.</p>
  </div>

  <div class="steps">

    <!-- STEP 1: Upload Video -->
    <div class="card" id="step1Card">
      <div class="card-num">Step 01 ‚Äî Video</div>
      <h3>Upload Your Video</h3>
      <div class="upload-zone" id="videoDropZone">
        <input type="file" id="videoInput" accept="video/mp4,video/quicktime,.mov,.mp4">
        <div class="upload-icon">üé¨</div>
        <div class="upload-label">Drop your video here</div>
        <div class="upload-sub">MP4 or MOV supported</div>
      </div>
      <div class="file-info" id="videoFileInfo" style="display:none">
        <span>üé¨</span>
        <span class="name" id="videoFileName"></span>
        <span class="remove" id="removeVideo">‚úï</span>
      </div>
    </div>

    <!-- STEP 2: Pick Effect -->
    <div class="card">
      <div class="card-num">Step 02 ‚Äî Style</div>
      <h3>Choose Your Effect</h3>
      <div class="effect-grid">
        <div class="effect-option active" data-effect="motion" onclick="selectEffect(this)">
          <span class="eff-icon">‚ö°</span>
          Motion Lines + Boxes
        </div>
        <div class="effect-option" data-effect="cyber" onclick="selectEffect(this)">
          <span class="eff-icon">üî∑</span>
          Cyber Grid Overlay
        </div>
        <div class="effect-option" data-effect="scan" onclick="selectEffect(this)">
          <span class="eff-icon">üì°</span>
          Scanline Radar
        </div>
        <div class="effect-option" data-effect="glitch" onclick="selectEffect(this)">
          <span class="eff-icon">üëæ</span>
          Glitch + Data HUD
        </div>
      </div>
    </div>

    <!-- STEP 3: Audio (optional) -->
    <div class="card">
      <div class="card-num">Step 03 ‚Äî Audio <em style="font-size:10px;color:var(--muted);font-style:normal">(optional)</em></div>
      <div class="toggle-wrap">
        <div>
          <div class="toggle-label">Replace Audio</div>
          <div class="toggle-sub">Swap original audio with your own file</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="audioToggle" onchange="toggleAudio(this)">
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
      </div>
      <div class="audio-upload-section" id="audioUploadSection">
        <div class="upload-zone" id="audioDropZone">
          <input type="file" id="audioInput" accept="audio/*">
          <div class="upload-icon">üéµ</div>
          <div class="upload-label">Drop audio file here</div>
          <div class="upload-sub">MP3, WAV, AAC, OGG supported</div>
        </div>
        <div class="file-info" id="audioFileInfo" style="display:none">
          <span>üéµ</span>
          <span class="name" id="audioFileName"></span>
          <span class="remove" id="removeAudio">‚úï</span>
        </div>
      </div>
    </div>

    <!-- STEP 4: Summary -->
    <div class="card" id="summaryCard">
      <div class="card-num">Step 04 ‚Äî Export</div>
      <h3>Settings Summary</h3>
      <div id="summaryContent" style="font-size:12px;color:var(--muted);line-height:2">
        <div>üìπ Video: <span id="sumVideo" style="color:var(--text)">None selected</span></div>
        <div>üé® Effect: <span id="sumEffect" style="color:var(--accent)">Motion Lines + Boxes</span></div>
        <div>üéµ Audio: <span id="sumAudio" style="color:var(--text)">Original (keep)</span></div>
        <div style="margin-top:12px;font-size:11px;padding:10px 12px;background:rgba(0,229,255,0.04);border:1px solid var(--border);border-radius:8px">
          ‚ö° Processing happens 100% in your browser ‚Äî your video never leaves your device.
        </div>
      </div>
    </div>

  </div>

  <!-- CTA -->
  <div class="cta-wrap">
    <button class="cta-btn" id="ctaBtn" onclick="startProcessing()" disabled>
      ‚ú® Make My Video Cool
    </button>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">Initializing...</div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section" id="previewSection">
    <div class="preview-header">
      <h3>üéâ Your Video</h3>
      <div class="badge">Ready to download</div>
    </div>
    <video class="video-preview" id="outputVideo" controls playsinline></video>
    <button class="download-btn" onclick="openDlPopup()">
      ‚¨áÔ∏è Download Video
    </button>
  </div>

  <footer>Built with <span>‚ô•</span> ‚Äî All processing done locally in your browser. No servers. No uploads.
  </footer>

</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let deviceMode = null;
let selectedEffect = 'motion';
let videoFile = null;
let audioFile = null;
let outputBlob = null;
let outputMimeType = 'video/webm';

// ‚îÄ‚îÄ DEVICE SELECTION ‚îÄ‚îÄ
function setDevice(type) {
  deviceMode = type;
  document.body.className = type;
  document.getElementById('devicePopup').style.display = 'none';
  const app = document.getElementById('mainApp');
  app.style.opacity = '1';
  app.style.pointerEvents = 'auto';
  const ind = document.getElementById('deviceIndicator');
  ind.textContent = type === 'pc' ? 'üñ•Ô∏è PC ‚Äî tap to switch' : 'üì± Mobile ‚Äî tap to switch';
}

function resetDevice() {
  document.getElementById('devicePopup').style.display = 'flex';
  const app = document.getElementById('mainApp');
  app.style.opacity = '0';
  app.style.pointerEvents = 'none';
}

// ‚îÄ‚îÄ EFFECT SELECTION ‚îÄ‚îÄ
function selectEffect(el) {
  document.querySelectorAll('.effect-option').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  selectedEffect = el.dataset.effect;
  updateSummary();
}

// ‚îÄ‚îÄ AUDIO TOGGLE ‚îÄ‚îÄ
function toggleAudio(checkbox) {
  const section = document.getElementById('audioUploadSection');
  section.classList.toggle('visible', checkbox.checked);
  updateSummary();
}

// ‚îÄ‚îÄ FILE HANDLING ‚îÄ‚îÄ
function setupFileInput(inputId, zoneId, infoId, nameId, removeId, type) {
  const input = document.getElementById(inputId);
  const zone = document.getElementById(zoneId);
  const info = document.getElementById(infoId);
  const nameEl = document.getElementById(nameId);
  const removeEl = document.getElementById(removeId);

  function handleFile(file) {
    if (!file) return;
    if (type === 'video') { videoFile = file; }
    else { audioFile = file; }
    nameEl.textContent = file.name;
    info.style.display = 'flex';
    updateSummary();
    updateCTA();
  }

  input.addEventListener('change', () => handleFile(input.files[0]));

  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    handleFile(e.dataTransfer.files[0]);
  });

  removeEl.addEventListener('click', () => {
    if (type === 'video') { videoFile = null; }
    else { audioFile = null; }
    input.value = '';
    info.style.display = 'none';
    updateSummary();
    updateCTA();
  });
}

setupFileInput('videoInput','videoDropZone','videoFileInfo','videoFileName','removeVideo','video');
setupFileInput('audioInput','audioDropZone','audioFileInfo','audioFileName','removeAudio','audio');

function updateSummary() {
  document.getElementById('sumVideo').textContent = videoFile ? videoFile.name : 'None selected';
  const effectLabels = {motion:'Motion Lines + Boxes',cyber:'Cyber Grid Overlay',scan:'Scanline Radar',glitch:'Glitch + Data HUD'};
  document.getElementById('sumEffect').textContent = effectLabels[selectedEffect];
  const audioOn = document.getElementById('audioToggle').checked;
  document.getElementById('sumAudio').textContent = audioOn ? (audioFile ? audioFile.name : 'Waiting for file...') : 'Original (keep)';
}

function updateCTA() {
  document.getElementById('ctaBtn').disabled = !videoFile;
}

// ‚îÄ‚îÄ PROCESSING ‚îÄ‚îÄ
async function startProcessing() {
  if (!videoFile) return;

  const progressWrap = document.getElementById('progressWrap');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const previewSection = document.getElementById('previewSection');
  const ctaBtn = document.getElementById('ctaBtn');

  ctaBtn.disabled = true;
  progressWrap.classList.add('visible');
  previewSection.classList.remove('visible');
  outputBlob = null;

  setProgress(0, 'Loading video...');

  const videoEl = document.getElementById('inputVideo');
  const canvas = document.getElementById('processCanvas');
  const ctx = canvas.getContext('2d');

  videoEl.src = URL.createObjectURL(videoFile);

  await new Promise(res => {
    videoEl.onloadedmetadata = res;
    videoEl.onerror = res;
  });

  const W = videoEl.videoWidth;
  const H = videoEl.videoHeight;
  canvas.width = W;
  canvas.height = H;

  setProgress(5, 'Setting up renderer...');

  // Output stream from canvas
  const canvasStream = canvas.captureStream(30);

  // Audio handling
  let audioStream = null;

  const audioOn = document.getElementById('audioToggle').checked;
  if (audioOn && audioFile) {
    const audioEl = document.getElementById('customAudio');
    audioEl.src = URL.createObjectURL(audioFile);
    await new Promise(res => { audioEl.oncanplay = res; audioEl.onerror = res; });
    // We'll mix audio in via AudioContext
    const actx = new AudioContext();
    const src = actx.createMediaElementSource(audioEl);
    const dst = actx.createMediaStreamDestination();
    src.connect(dst);
    audioStream = dst.stream;
  } else if (!audioOn) {
    // Capture original audio from video
    try {
      const actx = new AudioContext();
      const src2 = actx.createMediaElementSource(videoEl);
      const dst2 = actx.createMediaStreamDestination();
      src2.connect(dst2);
      audioStream = dst2.stream;
    } catch(e) { /* no audio */ }
  }

  // Combine streams
  let combinedStream;
  if (audioStream && audioStream.getAudioTracks().length > 0) {
    combinedStream = new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()]);
  } else {
    combinedStream = canvasStream;
  }

  // Pick codec
  const mimeTypes = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm'];
  let mime = mimeTypes.find(m => MediaRecorder.isTypeSupported(m)) || 'video/webm';
  outputMimeType = mime;

  const recorder = new MediaRecorder(combinedStream, { mimeType: mime, videoBitsPerSecond: 8000000 });
  const chunks = [];
  recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

  recorder.start(100);

  // Start playing
  videoEl.currentTime = 0;
  if (audioOn && audioFile) {
    document.getElementById('customAudio').currentTime = 0;
    document.getElementById('customAudio').play();
  }
  videoEl.play();

  const duration = videoEl.duration;

  // If custom audio, stop at video end
  if (audioOn && audioFile) {
    videoEl.onended = () => { document.getElementById('customAudio').pause(); };
  }

  // Frame-by-frame effect rendering
  let prevFrame = null;
  let time = 0;
  let lastTimestamp = null;

  function renderFrame(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const elapsed = (timestamp - lastTimestamp) / 1000;
    lastTimestamp = timestamp;

    if (videoEl.paused || videoEl.ended) {
      finishRecording();
      return;
    }

    time += elapsed;
    const progress = Math.min(videoEl.currentTime / duration, 1);
    setProgress(5 + progress * 90, `Rendering... ${Math.round(progress * 100)}%`);

    // Draw base frame
    ctx.drawImage(videoEl, 0, 0, W, H);

    // Apply selected effect
    applyEffect(ctx, W, H, time, prevFrame);

    // Save frame for motion detection
    try {
      prevFrame = ctx.getImageData(0, 0, W, H);
    } catch(e) { prevFrame = null; }

    requestAnimationFrame(renderFrame);
  }

  requestAnimationFrame(renderFrame);

  function finishRecording() {
    recorder.stop();
    if (audioOn && audioFile) document.getElementById('customAudio').pause();

    recorder.onstop = () => {
      outputBlob = new Blob(chunks, { type: mime });
      const url = URL.createObjectURL(outputBlob);
      const outVid = document.getElementById('outputVideo');
      outVid.src = url;
      outVid.load();

      setProgress(100, 'Done!');
      setTimeout(() => {
        progressWrap.classList.remove('visible');
        previewSection.classList.add('visible');
        previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        ctaBtn.disabled = false;
      }, 600);
    };
  }
}

function setProgress(pct, text) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = text;
}

// ‚îÄ‚îÄ EFFECTS ‚îÄ‚îÄ
function applyEffect(ctx, W, H, time, prevFrame) {
  switch(selectedEffect) {
    case 'motion': effectMotion(ctx, W, H, time, prevFrame); break;
    case 'cyber': effectCyber(ctx, W, H, time); break;
    case 'scan': effectScan(ctx, W, H, time); break;
    case 'glitch': effectGlitch(ctx, W, H, time, prevFrame); break;
  }
}

// EFFECT 1: Motion Lines + Bounding Boxes
function effectMotion(ctx, W, H, time, prevFrame) {
  const curFrame = ctx.getImageData(0, 0, W, H);
  
  // Detect motion regions
  let motionRegions = [];
  if (prevFrame) {
    const step = 16;
    for (let cy = step; cy < H - step; cy += step) {
      for (let cx = step; cx < W - step; cx += step) {
        let diff = 0;
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const idx = ((cy + ky * 4) * W + (cx + kx * 4)) * 4;
            const dr = curFrame.data[idx] - prevFrame.data[idx];
            const dg = curFrame.data[idx+1] - prevFrame.data[idx+1];
            const db = curFrame.data[idx+2] - prevFrame.data[idx+2];
            diff += Math.sqrt(dr*dr + dg*dg + db*db);
          }
        }
        if (diff > 180) motionRegions.push({ x: cx, y: cy });
      }
    }
  }

  // Draw scanning grid lines
  ctx.save();
  ctx.strokeStyle = 'rgba(0, 229, 255, 0.12)';
  ctx.lineWidth = 1;
  const gridSize = 48;
  for (let x = 0; x < W; x += gridSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = 0; y < H; y += gridSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // Horizontal scan line
  const scanY = (Math.sin(time * 0.8) * 0.5 + 0.5) * H;
  const scanGrad = ctx.createLinearGradient(0, scanY - 20, 0, scanY + 20);
  scanGrad.addColorStop(0, 'rgba(0,229,255,0)');
  scanGrad.addColorStop(0.5, 'rgba(0,229,255,0.18)');
  scanGrad.addColorStop(1, 'rgba(0,229,255,0)');
  ctx.fillStyle = scanGrad;
  ctx.fillRect(0, scanY - 20, W, 40);

  // Draw motion boxes & lines
  if (motionRegions.length > 0) {
    // Cluster into groups
    const clusters = clusterPoints(motionRegions, 64);
    clusters.forEach((cl, i) => {
      const mx = cl.cx, my = cl.cy;
      const bw = cl.w + 32, bh = cl.h + 32;
      const bx = mx - bw/2, by = my - bh/2;

      // Box corners
      const cornerLen = 14;
      ctx.strokeStyle = 'rgba(0, 229, 255, 0.9)';
      ctx.lineWidth = 2;

      [[bx,by],[bx+bw,by],[bx,by+bh],[bx+bw,by+bh]].forEach(([cx,cy],ci) => {
        const dx = ci%2===0?1:-1, dy = ci<2?1:-1;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+dx*cornerLen,cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx,cy+dy*cornerLen); ctx.stroke();
      });

      // Center crosshair
      ctx.strokeStyle = 'rgba(0,229,255,0.5)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(mx-8,my); ctx.lineTo(mx+8,my); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(mx,my-8); ctx.lineTo(mx,my+8); ctx.stroke();

      // Label
      ctx.fillStyle = 'rgba(0,229,255,0.9)';
      ctx.font = `bold 9px monospace`;
      ctx.fillText(`OBJ_${String(i).padStart(3,'0')}`, bx + 4, by - 4);

      // Motion trail line
      const trailLen = 30;
      ctx.strokeStyle = `rgba(0,229,255,${0.6 - i*0.1})`;
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(mx, my);
      ctx.lineTo(mx + Math.cos(time*2 + i) * trailLen, my + Math.sin(time*2 + i) * trailLen * 0.5);
      ctx.stroke();
    });
  }

  // Corner HUD elements
  drawHUD(ctx, W, H, time, motionRegions.length);
  ctx.restore();
}

// EFFECT 2: Cyber Grid
function effectCyber(ctx, W, H, time) {
  ctx.save();

  // Pulsing grid
  const pulse = Math.sin(time * 2) * 0.5 + 0.5;
  ctx.strokeStyle = `rgba(123, 47, 255, ${0.15 + pulse * 0.08})`;
  ctx.lineWidth = 1;

  const gs = 36;
  const offsetX = (time * 20) % gs;
  const offsetY = (time * 12) % gs;

  for (let x = -gs + offsetX; x < W + gs; x += gs) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = -gs + offsetY; y < H + gs; y += gs) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // Intersection dots
  ctx.fillStyle = `rgba(123, 47, 255, ${0.3 + pulse * 0.3})`;
  for (let x = offsetX; x < W; x += gs) {
    for (let y = offsetY; y < H; y += gs) {
      ctx.beginPath(); ctx.arc(x, y, 1.5, 0, Math.PI*2); ctx.fill();
    }
  }

  // Diagonal accent lines
  ctx.strokeStyle = `rgba(0,229,255,0.12)`;
  ctx.lineWidth = 1;
  for (let i = -H; i < W; i += 80) {
    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i + H, H); ctx.stroke();
  }

  // Center circle
  ctx.strokeStyle = `rgba(123,47,255,${0.4 + pulse*0.4})`;
  ctx.lineWidth = 1.5;
  ctx.setLineDash([4, 8]);
  ctx.beginPath();
  ctx.arc(W/2, H/2, 60 + pulse * 10, 0, Math.PI * 2);
  ctx.stroke();
  ctx.setLineDash([]);

  drawHUD(ctx, W, H, time, 0);
  ctx.restore();
}

// EFFECT 3: Scanline Radar
function effectScan(ctx, W, H, time) {
  ctx.save();

  // Scanlines
  for (let y = 0; y < H; y += 3) {
    ctx.fillStyle = 'rgba(0,0,0,0.18)';
    ctx.fillRect(0, y, W, 1);
  }

  // Sweeping radar line
  const angle = (time * 1.2) % (Math.PI * 2);
  const cx = W * 0.5, cy = H * 0.5;
  const r = Math.sqrt(cx*cx + cy*cy);

  const sweepGrad = ctx.createConicalGradient ? null : null;
  // Fallback: draw sweep manually
  for (let da = 0; da < Math.PI * 0.4; da += 0.04) {
    const a = angle - da;
    ctx.strokeStyle = `rgba(0, 229, 255, ${0.35 - da * 0.8})`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(a) * r, cy + Math.sin(a) * r);
    ctx.stroke();
  }

  // Radar tip bright dot
  ctx.fillStyle = 'rgba(0,229,255,0.95)';
  ctx.beginPath();
  ctx.arc(cx + Math.cos(angle)*r*0.95, cy + Math.sin(angle)*r*0.95, 3, 0, Math.PI*2);
  ctx.fill();

  // Radar circles
  [0.2,0.4,0.6,0.8].forEach(f => {
    ctx.strokeStyle = 'rgba(0,229,255,0.08)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(cx, cy, r*f, 0, Math.PI*2);
    ctx.stroke();
  });

  // Vignette
  const vig = ctx.createRadialGradient(cx, cy, r*0.3, cx, cy, r*1.2);
  vig.addColorStop(0, 'rgba(0,0,0,0)');
  vig.addColorStop(1, 'rgba(0,5,15,0.6)');
  ctx.fillStyle = vig;
  ctx.fillRect(0, 0, W, H);

  drawHUD(ctx, W, H, time, 0);
  ctx.restore();
}

// EFFECT 4: Glitch + Data HUD
function effectGlitch(ctx, W, H, time, prevFrame) {
  ctx.save();

  // Random glitch slices
  const glitchIntensity = Math.sin(time * 7) > 0.7 ? 1 : 0;
  if (glitchIntensity) {
    const numSlices = 5;
    for (let i = 0; i < numSlices; i++) {
      const sy = Math.random() * H;
      const sh = 4 + Math.random() * 20;
      const ox = (Math.random() - 0.5) * 30;
      const imgData = ctx.getImageData(0, sy, W, sh);
      ctx.putImageData(imgData, ox, sy);

      // Color channel shift
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = 'rgba(255,0,60,0.08)';
      ctx.fillRect(ox + 2, sy, W, sh);
      ctx.globalCompositeOperation = 'source-over';
    }
  }

  // Data stream columns
  ctx.font = '9px monospace';
  const cols = Math.floor(W / 14);
  for (let c = 0; c < cols; c += 3) {
    const x = c * 14;
    const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™#$%XYZABCDE'.split('');
    const char = chars[Math.floor((time * 8 + c) * 3) % chars.length];
    const alpha = 0.1 + Math.sin(time * 3 + c) * 0.08;
    ctx.fillStyle = `rgba(0,229,255,${alpha})`;
    const rows = Math.floor(H / 14);
    for (let r = 0; r < rows; r += 4) {
      ctx.fillText(char, x, r * 14 + ((time * 50 + c * 7) % (H)));
    }
  }

  // Data overlays
  const numBoxes = 4;
  for (let i = 0; i < numBoxes; i++) {
    const bx = (W * 0.1) + (W * 0.8 * i / numBoxes);
    const by = H * 0.15 + Math.sin(time * 0.8 + i) * H * 0.05;
    const bw = 90, bh = 28;
    ctx.strokeStyle = 'rgba(0,229,255,0.5)';
    ctx.lineWidth = 1;
    ctx.strokeRect(bx, by, bw, bh);
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(bx, by, bw, bh);
    ctx.fillStyle = 'rgba(0,229,255,0.8)';
    ctx.font = '9px monospace';
    ctx.fillText(`SIG_${String(Math.floor(time*10+i*17)%999).padStart(3,'0')}`, bx+6, by+17);
  }

  drawHUD(ctx, W, H, time, 0);
  ctx.restore();
}

// ‚îÄ‚îÄ SHARED HUD ‚îÄ‚îÄ
function drawHUD(ctx, W, H, time, motionCount) {
  ctx.font = '10px monospace';

  // Top left
  ctx.fillStyle = 'rgba(0,229,255,0.7)';
  ctx.fillText('VIZ:FX // ACTIVE', 12, 20);
  ctx.fillStyle = 'rgba(0,229,255,0.4)';
  ctx.fillText(`T:${time.toFixed(2)}s`, 12, 34);
  if (motionCount > 0) ctx.fillText(`OBJ:${motionCount}`, 12, 48);

  // Top right
  const ts = new Date().toISOString().substr(11,8);
  const tw = ctx.measureText(ts).width;
  ctx.fillStyle = 'rgba(0,229,255,0.5)';
  ctx.fillText(ts, W - tw - 12, 20);

  // Corner brackets
  const cLen = 20, cOff = 8;
  ctx.strokeStyle = 'rgba(0,229,255,0.4)';
  ctx.lineWidth = 1.5;

  // TL
  ctx.beginPath(); ctx.moveTo(cOff,cOff+cLen); ctx.lineTo(cOff,cOff); ctx.lineTo(cOff+cLen,cOff); ctx.stroke();
  // TR
  ctx.beginPath(); ctx.moveTo(W-cOff-cLen,cOff); ctx.lineTo(W-cOff,cOff); ctx.lineTo(W-cOff,cOff+cLen); ctx.stroke();
  // BL
  ctx.beginPath(); ctx.moveTo(cOff,H-cOff-cLen); ctx.lineTo(cOff,H-cOff); ctx.lineTo(cOff+cLen,H-cOff); ctx.stroke();
  // BR
  ctx.beginPath(); ctx.moveTo(W-cOff-cLen,H-cOff); ctx.lineTo(W-cOff,H-cOff); ctx.lineTo(W-cOff,H-cOff-cLen); ctx.stroke();
}

// ‚îÄ‚îÄ CLUSTER HELPER ‚îÄ‚îÄ
function clusterPoints(pts, radius) {
  const clusters = [];
  const used = new Set();

  pts.forEach((p, i) => {
    if (used.has(i)) return;
    const cluster = [p];
    used.add(i);

    pts.forEach((q, j) => {
      if (used.has(j)) return;
      if (Math.abs(p.x - q.x) < radius && Math.abs(p.y - q.y) < radius) {
        cluster.push(q);
        used.add(j);
      }
    });

    const minX = Math.min(...cluster.map(c=>c.x));
    const maxX = Math.max(...cluster.map(c=>c.x));
    const minY = Math.min(...cluster.map(c=>c.y));
    const maxY = Math.max(...cluster.map(c=>c.y));

    clusters.push({
      cx: (minX+maxX)/2,
      cy: (minY+maxY)/2,
      w: maxX-minX,
      h: maxY-minY,
      count: cluster.length
    });
  });

  return clusters.filter(c => c.count >= 1).slice(0, 6);
}

// ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ
function openDlPopup() {
  if (!outputBlob) return;
  document.getElementById('dlPopup').style.display = 'flex';
}

function closeDlPopup() {
  document.getElementById('dlPopup').style.display = 'none';
}

function downloadAs(format) {
  if (!outputBlob) return;

  const mimeMap = {
    mp4: 'video/mp4',
    webm: 'video/webm',
    mov: 'video/quicktime'
  };

  // Note: Browser MediaRecorder outputs WebM. MP4/MOV are aliased.
  const blob = new Blob([outputBlob], { type: mimeMap[format] });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vizfx_output.${format}`;
  a.click();
  URL.revokeObjectURL(url);
  closeDlPopup();
}

// Close download popup on overlay click
document.getElementById('dlPopup').addEventListener('click', function(e) {
  if (e.target === this) closeDlPopup();
});
</script>
</body>
</html>
